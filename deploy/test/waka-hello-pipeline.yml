resource_types:
  - name: appku-deploy
    type: docker-image
    source:
      repository: appku/waka
      tag: deploy

resources:
  - name: appku-deploy
    icon: flash
    type: appku-deploy
    source:
      host: ((host))
      debug: true
      sa:
        username: ((sa.username))
        password: ((sa.password))
        key: ((sa.key))

jobs:
  - name: put-get
    public: true
    plan:
      - task: dockerfile-compose
        config:
          platform: linux
          image_resource:
            type: registry-image
            source: { repository: appku/waka }
          outputs:
            - name: compose
              path: artifact
          run:
            path: /bin/bash
            args:
                - -ceu
                - |
                  tee ./artifact/Dockerfile << 'EOF'
                  FROM appku/waka:latest
                  CMD ["hello", "web"]
                  EOF
                  tee ./artifact/docker-compose.yml << 'EOF'
                  version: "3.8"
                  networks:
                    appku:
                      external: true
                  name: waka
                  services:
                    hello:
                      image: registry.localhost/hello
                      restart: on-failure
                      expose: [8080]
                      networks:
                        appku: 
                      labels:
                      - traefik.enable=true
                      - traefik.http.routers.hello.rule=HostRegexp(`hello.{domain:.*}`)
                      - traefik.http.routers.hello.entrypoints=http
                      - traefik.http.routers.hello.middlewares=https-redirect
                      - traefik.http.routers.hello-https.rule=HostRegexp(`hello.{domain:.*}`)
                      - traefik.http.routers.hello-https.entrypoints=https
                      - traefik.http.routers.hello-https.tls=true
                      - traefik.http.services.hello-https.loadbalancer.server.port=8080
                  EOF
      - put: appku-deploy
        params: 
          mode: image
          source: compose
          compose:
            timeout: 12
          image:
            path: registry.localhost/hello
            tags: [latest, 1.0.0]
            host: registry.localhost
      - put: appku-deploy
        params: 
          mode: compose
          source: compose